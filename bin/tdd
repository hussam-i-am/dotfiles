#!/usr/bin/env zsh

ext=$1
shift
echo "tdd with .${ext} files: $@"

running=false

function run() {
  echo
  echo "$(date | colorize 5) $@"
  echo
  running=true
  if "$@"; then
    echo "================================================================================" | colorize 2
  else
    echo "================================================================================" | colorize 1
  fi
  running=false
}

# only exit if not running. otherwise assume child process will respond
function maybequit() {
  if [ "$running" = 'true' ]; then
    running=false
  else
    exit 1
  fi
}

trap 'maybequit' SIGINT
run "$@"
while true; do
  if [ -n "$LINUX" ]; then
    # fswatch on linux sucks compared to fsnotify on mac, so just watch only the changed files
    git branch-changes | grep .$ext | xargs fswatch -1
  else
    fswatch -e'.*' -i "\\.${ext}" -1 .
  fi
  run "$@"
done
